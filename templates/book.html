{% extends "base.html" %}

{% block title %}Book a Room{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Book a Room</h2>
    <form id="bookingForm" method="POST" action="/book">
        <label for="room">Room:</label>
        <select id="room" name="room" required>
            {% for room in rooms %}
                <option value="{{ room }}">{{ room }}</option>
            {% endfor %}
        </select>

        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required>

        <label for="start">Start Time:</label>
        <input type="time" id="start" name="start" required>

        <label for="end">End Time:</label>
        <input type="time" id="end" name="end" required>

        <div id="availabilityStatus" class="status-msg"></div>

        <label for="recurrence">Recurrence:</label>
        <select id="recurrence" name="recurrence">
            <option value="none">None</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
        </select>

        <div id="recurrenceEndWrapper" style="display:none;">
            <label for="recurrence_end">Recurrence End Date:</label>
            <input type="date" id="recurrence_end" name="recurrence_end">
        </div>

        <button type="submit" class="btn">Book</button>
    </form>

    <div class="calendar">
        <h3>Room Availability</h3>
        <table class="availability-table">
            <tr><th>Date</th><th>Status</th></tr>
            {% for day in availability %}
                <tr>
                    <td>{{ day.date }}</td>
                    <td class="{{ 'available' if day.available else 'booked' }}">
                        {{ 'Available' if day.available else 'Booked' }}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
</div>

<style>
.available { color: green; }
.booked { color: red; }
</style>

<script>
document.getElementById('recurrence').addEventListener('change', function() {
    document.getElementById('recurrenceEndWrapper').style.display =
        (this.value !== 'none') ? 'block' : 'none';
});

// Real-time availability check
['date', 'start', 'end', 'room'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
        let room = document.getElementById('room').value;
        let date = document.getElementById('date').value;
        let start = document.getElementById('start').value;
        let end = document.getElementById('end').value;
        if(room && date && start && end) {
            fetch(`/check_availability?room=${room}&date=${date}&start=${start}&end=${end}`)
                .then(res => res.json())
                .then(data => {
                    let status = document.getElementById('availabilityStatus');
                    status.textContent = data.available ? "Available" : "Not Available";
                    status.style.color = data.available ? "green" : "red";
                });
        }
    });
});
</script>
{% endblock %}
